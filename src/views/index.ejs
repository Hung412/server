<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js"></script>
    <script src="../configs/connectDB.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <title>Home</title>
  </head>
  <body>
    <div class="w3-navbar">
      <a class="active" href="/home"><i class="fa fa-fw fa-home"></i>Home</a></a>
      <a href="/controll-panel"><i class="fa fa-fw fa-wrench"></i>Controll panel</a>
      <a href="/sign-in"><i class="fa fa-fw fa-bar-chart"></i>Sign in</a>
    </div>
    <div class="w3-container">
      <h2>Status table</h2>
      <div class="container">
        <canvas id="myChart" style="width:100%;max-width:700px"></canvas>
      </div>
      <div>
        <table class="w3-table-all w3-hoverable">
          <thead>
            <tr class="w3-light-gray">
              <th>ID</th>
              <th>Status</th>
              <th>Time</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <% for(let i=0; i < data.length; i++) { %>
              <tr>
                <td><%= data[i].id %></td>
                <td><%= data[i].status %></td>
                <td><%= data[i].timestatus %></td>
                <td>
                  <form action="/delete-status" , method="post">
                    <input
                      type="text"
                      hidden
                      value="<%= data[i].id %>"
                      name="statusId"
                    />
                    <button type="submit" class="btn-CRUD">Delete</button>
                  </form>
                </td>
            </tr>
            <% } %>
          </tbody>
    </div>

    <script type="text/javascript">
      const get_count = async() =>{
        const [count, fields] = await pool.execute('SELECT COUNT(*) AS `countstatus` FROM `trangthai` WHERE status = "open" UNION SELECT COUNT(*) AS `countclose` FROM `trangthai` WHERE status = "close" UNION SELECT COUNT(*) AS `counterror` FROM `trangthai` WHERE status = "error"');
        const countstatus = [];
        for(let i=0; i<count.length; i++){
          countstatus.push(count[i].countstatus);
        }
        console.log(countstatus);
      }
      var url = "ahkiot.herokuapp.com"; 
      var ws = new WebSocket("wss://" + url); 
      var xValues = ["Open", "Close", "Error"];
      var yValues = [data[0].countstatus, data[1].countstatus, data[2].countstatus];
      var barColors = ["green", "blue","red"];
      new Chart("myChart", {
      type: "bar",
      data: {
          labels: xValues,
          datasets: [{
          backgroundColor: barColors,
          data: yValues
          }]
      },
      options: {}
      });

      ws.onopen = function () 
      {
        get_count();
        ws.send(JSON.stringify({
          status: "Connected",
          pathname: '/home'
        }));
      };

      ws.onclose = function () {
        alert("Server destroyed!");
      };
    </script>
  </body>
</html>
